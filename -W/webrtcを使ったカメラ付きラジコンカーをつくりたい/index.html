<!DOCTYPE html>
<html><head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=34225&amp;path=blog/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://localhost:34225/blog/css/syntax.css">
    <link rel="stylesheet" href="http://localhost:34225/blog/css/single.css">
    <link rel="stylesheet" href="http://localhost:34225/blog/css/header.css">
    <link rel="stylesheet" href="http://localhost:34225/blog/css/footer.css">
    <link rel="stylesheet" href="http://localhost:34225/blog/css/list.css">
    <link rel="stylesheet" href="http://localhost:34225/blog/css/baseof.css">
    <script src="http://localhost:34225/blog/js/header.js"></script>
    <meta name="msapplication-square70x70logo" content="/favicon/site-tile-70x70.png">
    <meta name="msapplication-square150x150logo" content="/favicon/site-tile-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/favicon/site-tile-310x150.png">
    <meta name="msapplication-square310x310logo" content="/favicon/site-tile-310x310.png">
    <meta name="msapplication-TileColor" content="#0078d7">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="http://localhost:34225/blog/favicon/favicon.ico">
    <link rel="icon" type="image/vnd.microsoft.icon" href="http://localhost:34225/blog/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="57x57" href="http://localhost:34225/blog/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="http://localhost:34225/blog/favicon/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:34225/blog/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="http://localhost:34225/blog/favicon/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:34225/blog/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="http://localhost:34225/blog/favicon/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:34225/blog/favicon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="http://localhost:34225/blog/favicon/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:34225/blog/favicon/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="36x36" href="http://localhost:34225/blog/favicon/android-chrome-36x36.png">
    <link rel="icon" type="image/png" sizes="48x48" href="http://localhost:34225/blog/favicon/android-chrome-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" href="http://localhost:34225/blog/favicon/android-chrome-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="http://localhost:34225/blog/favicon/android-chrome-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="http://localhost:34225/blog/favicon/android-chrome-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="http://localhost:34225/blog/favicon/android-chrome-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="http://localhost:34225/blog/favicon/android-chrome-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="http://localhost:34225/blog/favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="256x256" href="http://localhost:34225/blog/favicon/android-chrome-256x256.png">
    <link rel="icon" type="image/png" sizes="384x384" href="http://localhost:34225/blog/favicon/android-chrome-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="http://localhost:34225/blog/favicon/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="36x36" href="http://localhost:34225/blog/favicon/icon-36x36.png">
    <link rel="icon" type="image/png" sizes="48x48" href="http://localhost:34225/blog/favicon/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" href="http://localhost:34225/blog/favicon/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="http://localhost:34225/blog/favicon/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="http://localhost:34225/blog/favicon/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="http://localhost:34225/blog/favicon/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="http://localhost:34225/blog/favicon/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="160x160" href="http://localhost:34225/blog/favicon/icon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="http://localhost:34225/blog/favicon/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="196x196" href="http://localhost:34225/blog/favicon/icon-196x196.png">
    <link rel="icon" type="image/png" sizes="256x256" href="http://localhost:34225/blog/favicon/icon-256x256.png">
    <link rel="icon" type="image/png" sizes="384x384" href="http://localhost:34225/blog/favicon/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="http://localhost:34225/blog/favicon/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://localhost:34225/blog/favicon/icon-16x16.png">
    <link rel="icon" type="image/png" sizes="24x24" href="http://localhost:34225/blog/favicon/icon-24x24.png">
    <link rel="icon" type="image/png" sizes="32x32" href="http://localhost:34225/blog/favicon/icon-32x32.png">
    <title>
        いつか黒歴史
        
    </title>
</head><body><header>
    <div id="header-visual">
        <div id="main-logo-wrapper">
            <a href="http://localhost:34225/blog/" id="main-logo"
                style="filter:  drop-shadow(1px 1px 0px rgb(59, 0, 102))  drop-shadow(2px 2px 0px rgb(59, 0, 102))  drop-shadow(3px 3px 0px rgb(59, 0, 102))  drop-shadow(4px 4px 0px rgb(59, 0, 102))  drop-shadow(5px 5px 0px rgb(59, 0, 102))  drop-shadow(6px 6px 0px rgb(59, 0, 102))  drop-shadow(7px 7px 0px rgb(59, 0, 102))  drop-shadow(8px 8px 0px rgb(59, 0, 102))  drop-shadow(9px 9px 0px rgb(59, 0, 102))  drop-shadow(10px 10px 0px rgb(59, 0, 102)) ;">
                いつか黒歴史
            </a>
        </div>
        <div id="counter-wrapper">
            あなたは<div id="counter"></div>人目の訪問者です
        </div>
    </div>
    <div id="taxonomy-menu">
        
        <a href='http://localhost:34225/blog/archives' class="taxonomy-btn">archives</a>
        
        <a href='http://localhost:34225/blog/tags' class="taxonomy-btn">tags</a>
        
    </div>
</header><div id="content">
  
    <a class="article-date" href="http://localhost:34225/blog/archives/2020-12/">2020年12月17日</a>
  
  <h1>WebRTCを使ったカメラ付きラジコンカーをつくりたい</h1>
  
    <a class="article-tag" href="http://localhost:34225/blog/tags/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA/">環境構築シリーズ</a>
  
    <a class="article-tag" href="http://localhost:34225/blog/tags/raspberry-pi/">Raspberry Pi</a>
  
    <a class="article-tag" href="http://localhost:34225/blog/tags/linux/">Linux</a>
  
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#webrtcとは">WebRTCとは</a></li>
    <li><a href="#インストール">インストール</a></li>
    <li><a href="#ローカルで動かす">ローカルで動かす</a></li>
    <li><a href="#遠隔で動かす">遠隔で動かす</a>
      <ul>
        <li><a href="#知人のubuntu上で環境構築">知人のUbuntu上で環境構築</a></li>
        <li><a href="#動かしてみる">動かしてみる</a></li>
      </ul>
    </li>
    <li><a href="#コントロールする">コントロールする</a>
      <ul>
        <li><a href="#仮想シリアルデバイスをつくる">仮想シリアルデバイスをつくる</a></li>
        <li><a href="#--serialオプションを付けて動かしてみる">&ndash;serialオプションを付けて動かしてみる</a></li>
      </ul>
    </li>
    <li><a href="#タイヤを履かせたいしボディも着せたい">タイヤを履かせたいし，ボディも着せたい</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>この記事は<a href="https://adventar.org/calendars/5509">東京高専プロコンゼミ① Advent Calendar 2020</a>の10日目です．</p>
<p><a href="https://github.com/shiguredo/momo">WebRTC Native Client Momo</a>とRaspberry Piを使って，遠くから操作できるカメラ付きラジコンﾓﾄﾞｷを作りたいという記事です．</p>
<p>タイトルにWebRTCと入っていますが，WebRTCについてよくわかってないです．ごめんなさい．</p>
<h2 id="webrtcとは">WebRTCとは</h2>
<blockquote>
<p>WebRTCを使用すると、オープンスタンダード上で動作するリアルタイム通信機能をアプリケーションに追加できます。出典:<a href="https://webrtc.org/">WebRTC</a></p>
</blockquote>
<p>今回はAndroid上のGoogle ChromeとRaspberry Pi上の<a href="https://github.com/shiguredo/momo">WebRTC Native Client Momo</a>で通信を行います．</p>
<h2 id="インストール">インストール</h2>
<p>Momoの<a href="https://github.com/shiguredo/momo/releases">Relese</a>より自分にあったファイルをダウンロードします．Raspberry Pi 2,3,4は<code>momo-&lt;VERSION&gt;_raspberry-pi-os_armv7.tar.gz</code>という名前のファイルです．<code>tar xvf [ファイル名]</code>で解凍できます．中にある<code>momo</code>が実行ファイルです．</p>
<p>以下で必要なパッケージを入れておきます．</p>
<pre><code>sudo apt-get install libnspr4 libnss3
</code></pre><h2 id="ローカルで動かす">ローカルで動かす</h2>
<p>ひとまずRaspberry PiとAndroid端末がローカルネットワークにある状態で動かしてみます．</p>
<p>Momoをtestモードで起動します．</p>
<pre><code>./momo --no-audio-device test
</code></pre><p>AndroidのChromeのアドレスバー以下を入力します．</p>
<pre><code>&lt;Raspberry PiのIPアドレス&gt;:8080/html/test.html
</code></pre><p>すると以下のようなページが表示されます．<br>


	



	
	<a href="http://localhost:34225/blog/webrtc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%9F%E3%81%84/momop2p.jpg">
		<img src="http://localhost:34225/blog/webrtc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%9F%E3%81%84/momop2p_hu6ca6ec33d94ac90256b8f17d577a9972_75244_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
<br>
Connectを押すことでカメラの映像が表示されます．

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/jaVhUnFPHpg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
<br>
低遅延です．</p>
<h2 id="遠隔で動かす">遠隔で動かす</h2>
<p>WebRTCでP2P接続するためには，お互いの情報をお互いに渡してくれるシグナリングサーバーというものが必要になります．<br>
ローカルで動かすtestモードでは、Momoがシグナリングサーバーになっていたのですが，今回はMomoと同じく時雨堂様が開発している<a href="https://ayame-labo.shiguredo.jp/">Ayame Labo</a>を使い，<!-- raw HTML omitted -->Raspberry Pi<!-- raw HTML omitted -->UbuntuとAndroid端末がLAN内になくても接続できるようにします．</p>
<p>けしからんネットワークにより，手元のRaspberry Piではうまく接続ができないので，長野県にいる知人に頼んで，Ubuntuで動かしてもらいました．<br>


	



	
	<a href="http://localhost:34225/blog/webrtc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%9F%E3%81%84/naganoken.jpg">
		<img src="http://localhost:34225/blog/webrtc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%9F%E3%81%84/naganoken_hu11ef85ecbce96c832980b9ae17da8e65_1093401_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
</p>
<h3 id="知人のubuntu上で環境構築">知人のUbuntu上で環境構築</h3>
<p>Momoのインストールは省きます．</p>
<p>どうやらカメラがついていないようなので，<a href="https://github.com/umlaeute/v4l2loopback">v4l2loopback</a>で仮想カメラを作ります．</p>
<p>以下でビルドを行います．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/umlaeute/v4l2loopback.git
make <span style="color:#f92672">&amp;&amp;</span> sudo make install
</code></pre></div><p>読み込みます．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo modprobe v4l2loopback
</code></pre></div><p>このままでは何も映っていないカメラなので，ffmpegで動画を流し込みます．<code>-stream_loop -1</code>で動画が無限ループします．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ffmpeg -stream_loop -1 -re -i <span style="color:#f92672">[</span>動画ファイル名<span style="color:#f92672">]</span>.mp4 -f v4l2 /dev/video0
</code></pre></div><h3 id="動かしてみる">動かしてみる</h3>
<p><a href="https://ayame-labo.shiguredo.jp/">Ayame Labo</a>にサインアップして，ルームIDとシグナリングキーを控えておきます．</p>
<p>AyameモードでMomoを起動します．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./momo --no-audio-device ayame wss://ayame-labo.shiguredo.jp/signaling <span style="color:#f92672">[</span>Ayame LaboのルームID<span style="color:#f92672">]</span> --signaling-key <span style="color:#f92672">[</span>Ayame Laboのシグナリングキー<span style="color:#f92672">]</span>
</code></pre></div><p><a href="https://ayame-labo.shiguredo.jp/">Ayame Labo</a>にサンプルがあるので，そちらを使わせていただきました．<br>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/YJfgqOsKTt4" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
</p>
<p>ネットワークの問題かMomoが動いているマシンの問題かわかりませんが，カクツクことがあります．</p>
<p>流れている動画は，以前箱根のほうに行った時のものです．<br>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/-0qL0tsNuvU" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
</p>
<h2 id="コントロールする">コントロールする</h2>
<p>このままではただカメラの映像を垂れ流しているだけなので，コントロールできないので，なにか文字列を送れるようにしてみます．</p>
<p>Momoは<code>--serial /dev/ttyhoge,huge</code>オプションをつけることでWebRTCのデータチャネルとシリアルポートを繋げる?ことができます．
今回は都合のいいシリアルデバイスがないので，<code>socat</code>で仮想シリアルデバイスを作ります．</p>
<h3 id="仮想シリアルデバイスをつくる">仮想シリアルデバイスをつくる</h3>
<p><code>socat</code>をインストールします．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt install socat
</code></pre></div><p><a href="https://www.youtube.com/watch?v=iFmD-CeB96A">こちらの動画</a>をp参考にさせていただきました．
以下を実行して表示されたシリアルポート同士が繋がっています．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">socat -d -d pty,raw,echo<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> pty,raw,echo<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">2020/12/04 18:23:04 socat<span style="color:#f92672">[</span>1664<span style="color:#f92672">]</span> N PTY is /dev/pts/1
2020/12/04 18:23:04 socat<span style="color:#f92672">[</span>1664<span style="color:#f92672">]</span> N PTY is /dev/pts/2
2020/12/04 18:23:04 socat<span style="color:#f92672">[</span>1664<span style="color:#f92672">]</span> N starting data transfer loop with FDs <span style="color:#f92672">[</span>5,5<span style="color:#f92672">]</span> and <span style="color:#f92672">[</span>7,7<span style="color:#f92672">]</span>
</code></pre></div><p>今回の場合は，<code>/dev/pts/1</code>と<code>/dev/pts/2</code>のようです．</p>
<h3 id="--serialオプションを付けて動かしてみる">&ndash;serialオプションを付けて動かしてみる</h3>
<p>今回のMomoの起動コマンドです．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./momo -- serial /dev/pts/1,9600 --no-audio-device ayame wss://ayame-labo.shiguredo.jp/signaling <span style="color:#f92672">[</span>ルームID<span style="color:#f92672">]</span> --signaling-key <span style="color:#f92672">[</span>シグナリングキー<span style="color:#f92672">]</span>
</code></pre></div><p><code>cat</code>でシリアルポートを覗きます．</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat /dev/pts/2
</code></pre></div>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/GnWfptz4fR0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>こんな感じで映像以外も送受信できます．Youtubeの動画のほうはUbuntuとAndroid別々に録画していますが，電波時計を見ながらタイミングをとったので，互いの録画にあまりズレはないと思います．</p>
<h2 id="タイヤを履かせたいしボディも着せたい">タイヤを履かせたいし，ボディも着せたい</h2>
<p>車体やコントローラーは現在友人らと制作中です．</p>
<p>今回は<code>cat</code>を使っていましたが，PythonやCで<code>socat</code>のシリアルポートを読んで，Raspberry PiのGPIOを制御すればラジコンみたいになると思います．Arduinoとかを繋いでもいいかもね&hellip;</p>
<p><a href="https://github.com/OpenAyame/ayame-web-sdk"> OpenAyame/ayame-web-sdk </a></p>
<p>

	



	
	<a href="http://localhost:34225/blog/webrtc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%9F%E3%81%84/controller.jpg">
		<img src="http://localhost:34225/blog/webrtc%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AB%E3%83%A1%E3%83%A9%E4%BB%98%E3%81%8D%E3%83%A9%E3%82%B8%E3%82%B3%E3%83%B3%E3%82%AB%E3%83%BC%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%9F%E3%81%84/controller_huc684a1e9a4c552ea6fb29923fbe21ce6_106313_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
<br>
制作途中のコントローラー</p>


        </div><footer>
    <p id="copyright">
        &copy; 2021 nPeeech.
    </p>
</footer></body>
</html>
