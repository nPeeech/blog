<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://npeeech.github.io/blog/css/syntax.css">
    <link rel="stylesheet" href="https://npeeech.github.io/blog/css/single.css">
    <link rel="stylesheet" href="https://npeeech.github.io/blog/css/header.css">
    <link rel="stylesheet" href="https://npeeech.github.io/blog/css/footer.css">
    <link rel="stylesheet" href="https://npeeech.github.io/blog/css/list.css">
    <link rel="stylesheet" href="https://npeeech.github.io/blog/css/baseof.css">
    <script src="https://npeeech.github.io/blog/js/header.js"></script>
    
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B091BVYLCR"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-B091BVYLCR');
    </script>
    
    
    <meta name="msapplication-square70x70logo" content="/favicon/site-tile-70x70.png">
    <meta name="msapplication-square150x150logo" content="/favicon/site-tile-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/favicon/site-tile-310x150.png">
    <meta name="msapplication-square310x310logo" content="/favicon/site-tile-310x310.png">
    <meta name="msapplication-TileColor" content="#0078d7">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://npeeech.github.io/blog/favicon/favicon.ico">
    <link rel="icon" type="image/vnd.microsoft.icon" href="https://npeeech.github.io/blog/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="57x57" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://npeeech.github.io/blog/favicon/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="36x36" href="https://npeeech.github.io/blog/favicon/android-chrome-36x36.png">
    <link rel="icon" type="image/png" sizes="48x48" href="https://npeeech.github.io/blog/favicon/android-chrome-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" href="https://npeeech.github.io/blog/favicon/android-chrome-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://npeeech.github.io/blog/favicon/android-chrome-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="https://npeeech.github.io/blog/favicon/android-chrome-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="https://npeeech.github.io/blog/favicon/android-chrome-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="https://npeeech.github.io/blog/favicon/android-chrome-152x152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://npeeech.github.io/blog/favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="256x256" href="https://npeeech.github.io/blog/favicon/android-chrome-256x256.png">
    <link rel="icon" type="image/png" sizes="384x384" href="https://npeeech.github.io/blog/favicon/android-chrome-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://npeeech.github.io/blog/favicon/android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="36x36" href="https://npeeech.github.io/blog/favicon/icon-36x36.png">
    <link rel="icon" type="image/png" sizes="48x48" href="https://npeeech.github.io/blog/favicon/icon-48x48.png">
    <link rel="icon" type="image/png" sizes="72x72" href="https://npeeech.github.io/blog/favicon/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://npeeech.github.io/blog/favicon/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="https://npeeech.github.io/blog/favicon/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="144x144" href="https://npeeech.github.io/blog/favicon/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="152x152" href="https://npeeech.github.io/blog/favicon/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="160x160" href="https://npeeech.github.io/blog/favicon/icon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://npeeech.github.io/blog/favicon/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="196x196" href="https://npeeech.github.io/blog/favicon/icon-196x196.png">
    <link rel="icon" type="image/png" sizes="256x256" href="https://npeeech.github.io/blog/favicon/icon-256x256.png">
    <link rel="icon" type="image/png" sizes="384x384" href="https://npeeech.github.io/blog/favicon/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://npeeech.github.io/blog/favicon/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://npeeech.github.io/blog/favicon/icon-16x16.png">
    <link rel="icon" type="image/png" sizes="24x24" href="https://npeeech.github.io/blog/favicon/icon-24x24.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://npeeech.github.io/blog/favicon/icon-32x32.png">
    <title>
         WebRTCを使ったカメラ付きラジコンカーを作った |  いつか黒歴史
    </title>
</head><body><header>
    <div id="header-visual">
        <div id="main-logo-wrapper">
            <a href="https://npeeech.github.io/blog/" id="main-logo"
                style="filter:  drop-shadow(1px 1px 0px rgb(59, 0, 102))  drop-shadow(2px 2px 0px rgb(59, 0, 102))  drop-shadow(3px 3px 0px rgb(59, 0, 102))  drop-shadow(4px 4px 0px rgb(59, 0, 102))  drop-shadow(5px 5px 0px rgb(59, 0, 102))  drop-shadow(6px 6px 0px rgb(59, 0, 102))  drop-shadow(7px 7px 0px rgb(59, 0, 102))  drop-shadow(8px 8px 0px rgb(59, 0, 102))  drop-shadow(9px 9px 0px rgb(59, 0, 102))  drop-shadow(10px 10px 0px rgb(59, 0, 102)) ;">
                いつか黒歴史
            </a>
        </div>
        <div id="counter-wrapper">
            あなたは<div id="counter"></div>人目の訪問者です
        </div>
    </div>
    <div id="taxonomy-menu">
        
        <a href='https://npeeech.github.io/blog/archives' class="taxonomy-btn">archives</a>
        
        <a href='https://npeeech.github.io/blog/tags' class="taxonomy-btn">tags</a>
        
    </div>
</header><div id="content">
  
    <a class="article-date" href="https://npeeech.github.io/blog/archives/2021-06/">2021年6月26日</a>
  
  <h1>WebRTCを使ったカメラ付きラジコンカーを作った</h1>
  
    <a class="article-tag" href="https://npeeech.github.io/blog/tags/raspberry-pi/">Raspberry Pi</a>
  
    <a class="article-tag" href="https://npeeech.github.io/blog/tags/linux/">Linux</a>
  
    <a class="article-tag" href="https://npeeech.github.io/blog/tags/arduino/">Arduino</a>
  
    <a class="article-tag" href="https://npeeech.github.io/blog/tags/%E9%9B%BB%E5%AD%90%E5%B7%A5%E4%BD%9C/">電子工作</a>
  
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#構成">構成</a></li>
    <li><a href="#制作過程">制作過程</a></li>
    <li><a href="#走行風景">走行風景</a></li>
    <li><a href="#制作中に詰まったところ">制作中に詰まったところ</a>
      <ul>
        <li><a href="#raspberry-pi-zerowでシリアル通信をする">Raspberry Pi zero　wでシリアル通信をする</a></li>
        <li><a href="#arduino-microでシリアル通信をする">Arduino microでシリアル通信をする</a></li>
        <li><a href="#momoの起動コマンド">Momoの起動コマンド</a></li>
      </ul>
    </li>
    <li><a href="#使用したもの">使用したもの</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>この記事は、<a href="https://npeeech.github.io/blog/camera_car_concept_using_webrtc/">WebRTCを使ったカメラ付きラジコンカーをつくりたい</a>を実際に作ってみたというものです。つまり、カメラの付いたラジコン（ラジコンではない）カーを作ってみた記事です。<br>
作ったのが執筆時の半年前なので、あまり覚えておらず内容が薄くなってます。</p>
<h2 id="構成">構成</h2>


	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros_diagram2.png">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros_diagram2_hu5582307656c7148e96a1f8aa7aa73873_136310_500x500_fit_q70_bgffffff_box_2.jpg" alt="" style="width: min(100%, 500px);">
	</a>

<ul>
<li>Raspberry Piに取り付けた専用のカメラで映像の送る</li>
<li>Raspberry Piは、コントローラーから送信された移動用モーターを制御するコマンドをArdunoにそのまま渡す</li>
<li>映像とコマンドのやり取りには<a href="https://github.com/shiguredo/momo">Momo</a>を使う</li>
<li>ArdunoのGPIOは5V、Raspberry PiのGPIOは3.3Vなのでレベル変換モジュールを使う</li>
<li>Pi cameraはAmazonで600円くらいで打ってる怪しいものを使用</li>
</ul>
<h2 id="制作過程">制作過程</h2>
<p>とりあえず、Arduinoとモータードライバでモーターを動かしてみました。<br>
なるべく小さくしようとモータードライバのターミナルブロックを下向きにつけているのですが、シルクのプリントが表にしかないので、VccとGNDを逆に接続してしまい一つ壊しています。<br>


	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/arduino_motordriver.jpg">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/arduino_motordriver_hucf8602bcf008031bbe35b55014475ced_4537673_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
</p>
<p>Arduino、Raspberry Pi、モータードライバ、レベル変換モジュールを接続するだけの基板なので単純な配線です。（一度失敗してやけくそでやったものなので、配線がアレですが）<br>
<a href="https://github.com/nPeeech/MiniBros/blob/main/Circuits/circuit.svg">なんとなくな配線図</a>もあります。<br>


	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/circuit.jpg">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/circuit_hu8f5a7fb1535f743d2316f5edbe28ece2_1956193_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
</p>
<p>モータードライバを壊して到着を待っている間に組んでみたところです。後ろのPCにはコントローラーが表示されています。Raspberry Piのカメラの映像です。<br>


	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/non_motor_driver.jpg">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/non_motor_driver_hu04561409813fa0a2e31a89b3124f5576_1063784_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
</p>
<p>数日後、モータードライバーが届いたので完成しました。ちなみに、Arduino microも破壊して書き込めなくなりましたが、こちらはもともと2つ持っていたので事なきを得ました。Raspberry Piとモバイルバッテリーの接続が非常に汚いですが、めんどくさくなってこうなりました。<br>


	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros1.jpg">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros1_hucf8602bcf008031bbe35b55014475ced_4972545_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>



	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros2.jpg">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros2_hucf8602bcf008031bbe35b55014475ced_3783325_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>



	



	
	<a href="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros2.jpg">
		<img src="https://npeeech.github.io/blog/camera_car_using_webrtc/minibros2_hucf8602bcf008031bbe35b55014475ced_3783325_500x500_fit_q70_box.jpg" alt="" style="width: min(100%, 500px);">
	</a>
</p>
<h2 id="走行風景">走行風景</h2>
<p>画質が酷いのは、600円の怪しいPi cameraを使っているためです。安かったからね、仕方ないね。操作はWASDで行えるようにしています。

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/ClR-fIPTxZA" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/6fC4Mb3R_VQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
</p>
<h2 id="制作中に詰まったところ">制作中に詰まったところ</h2>
<h3 id="raspberry-pi-zerowでシリアル通信をする">Raspberry Pi zero　wでシリアル通信をする</h3>
<p><strong>詳しいことは<a href="https://www.raspberrypi.org/documentation/configuration/uart.md">公式のUART configuration</a>を見てください。</strong><br>
ソフトウェアのmini uartとハードウェアのPL011が存在し、Raspberry Pi zero wでは最初、GPIOにはmini uartが設定されており無効化されています。PL011はBluetoothに使われています。<br>
そのため、Bluetoothを無効化し、PL011をGPIOに設定します。私が行った設定は以下の通りです。</p>
<ol>
<li>raspi-config → serial port
<ol>
<li>Would you like a login shell to be accessible over serial?にno</li>
<li>Would you like the serial port hardware to be enabled?にyes</li>
</ol>
</li>
<li><code>/boot/config.txt</code>に<code>dtoverlay=disable-bt</code>を追記</li>
</ol>
<p><code>/dev/ttyAMA0</code>がPL011、<code>/dev/serial0</code>は常にGPIOのシリアルデバイス(<code>/dev/ttyS0</code>か<code>/dev/ttyAMA0</code>)を指すシンボリックリンクです。</p>
<h3 id="arduino-microでシリアル通信をする">Arduino microでシリアル通信をする</h3>
<p>Arduino Unoでは、SerialクラスがGPIOのRX、TXとUSBシリアルで共有されていますが、Arduino microでは独立しておりSerial0クラスはUSBシリアル、Serial1クラスはGPIOのRX、TXになってます。これをまったく知らなくて1時間近く詰まっていました。</p>
<h3 id="momoの起動コマンド">Momoの起動コマンド</h3>
<p>serialオプションを付けて、<code>/dev/serial0</code>を指定することで、datachannelを使って送信された内容がArdunoに渡されます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./momo --no-audio-device --serial /dev/serial0,9600 --force-i420 --hw-mjpeg-decoder true ayame wss://ayame-labo.shiguredo.jp/signaling &lt;username&gt;@&lt;roomId&gt; --signaling-key &lt;signaling key&gt;
</code></pre></div><h2 id="使用したもの">使用したもの</h2>
<ul>
<li>
<p>部品</p>
<ul>
<li>秋月
<ul>
<li>モータードライバ
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/gK-11219/">https://akizukidenshi.com/catalog/g/gK-11219/</a></li>
</ul>
</li>
<li>基板
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/gP-03229/">https://akizukidenshi.com/catalog/g/gP-03229/</a></li>
</ul>
</li>
<li>電池ボックス
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/gP-11523/">https://akizukidenshi.com/catalog/g/gP-11523/</a></li>
</ul>
</li>
<li>ターミナルブロック用のコネクタ
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/gC-09247/">https://akizukidenshi.com/catalog/g/gC-09247/</a></li>
</ul>
</li>
<li>UART用のレベル変換モジュール
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/gK-13837/">https://akizukidenshi.com/catalog/g/gK-13837/</a></li>
</ul>
</li>
<li>ピンソケット（メス）
<ul>
<li><a href="https://akizukidenshi.com/catalog/g/gC-05779/">https://akizukidenshi.com/catalog/g/gC-05779/</a></li>
</ul>
</li>
</ul>
</li>
<li>ヨドバシ
<ul>
<li>ユニバーサルプレート
<ul>
<li><a href="https://www.yodobashi.com/product/100000001001083283/">https://www.yodobashi.com/product/100000001001083283/</a></li>
</ul>
</li>
</ul>
</li>
<li>その他
<ul>
<li>カメラ固定用のMDF</li>
<li>M2のねじ</li>
<li>Arduino micro</li>
<li>Raspberry Pi zero w</li>
<li>ユニバーサル基板</li>
<li>ユニバーサルアーム</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ソフト</p>
<ul>
<li><a href="https://github.com/shiguredo/momo">WebRTC Native Client Momo</a></li>
</ul>
</li>
<li>
<p>作ったソフトや回路図ﾓﾄﾞｷなど</p>
<ul>
<li><a href="https://github.com/nPeeech/MiniBros">https://github.com/nPeeech/MiniBros</a></li>
</ul>
</li>
</ul>


        </div><footer>
    <p id="copyright">
        &copy; 2021 nPeeech.
    </p>
</footer></body>
</html>
